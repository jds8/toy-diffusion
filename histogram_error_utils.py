#!/usr/bin/env python3

import numpy as np
import torch
import einops
from compute_quadratures import get_2d_pdf, estimate_integral
from hydra.core.hydra_config import HydraConfig
import scipy.integrate as integrate
import matplotlib.pyplot as plt
import einops
from typing import Optional, Callable

import os

import re
import imageio


# provenance: https://stackoverflow.com/questions/5967500/how-to-correctly-sort-a-string-with-a-number-inside
def atoi(text):
    return int(text) if text.isdigit() else text

def natural_keys(text):
    '''
    alist.sort(key=natural_keys) sorts in human order
    http://nedbatchelder.com/blog/200712/human_sorting.html
    (See Toothy's implementation in the comments)
    '''
    return [ atoi(c) for c in re.split(r'(\d+)', text) ]

def _create_gif(file_dir, gif_name=None):
    filenames = os.listdir(file_dir)
    filenames.sort(key=natural_keys)
    gif_name = gif_name if gif_name is not None else filenames[0]
    images = []
    for filename in filenames:
        jpg = os.path.join(file_dir, filename)
        if jpg.endswith('.jpg'):
            images.append(imageio.imread(jpg))
    imageio.mimsave('{}/{}.gif'.format(file_dir, gif_name), images)


#########################
#### Prop Calculator ####
#########################
class AnalyticalCalculator:
    def __call__(self, bins: np.ndarray, alpha: np.ndarray):
        return self.compute(bins, alpha)
    def compute(self, bins: np.ndarray, alpha: np.ndarray):
        raise NotImplementedError

class DensityCalculator(AnalyticalCalculator):
    def __init__(self, dist):
        """ dist should be a scipy distribution """
        self.dist = dist
    def compute(self, bins: np.ndarray, alpha: np.ndarray):
        x_grid = np.linspace(bins[:-1], bins[1:], 20)
        return self.dist.pdf(x_grid) / (1 - self.dist.cdf(alpha)), x_grid

class SimpsonsRuleCalculator(AnalyticalCalculator):
    def __init__(
            self,
            quadrature_fn: Callable,
            pdf_values_dir: Optional[str]=None
    ):
        self.pdf_values = None
        self.save_pdf_values = True
        self.load_pdf_values = pdf_values_dir != ''
        self.pdf_values_dir = f'{HydraConfig.get().run.dir}/simpsons_rule_pdf_values/'
        self.pdf_values_map = {}
        if pdf_values_dir:
            self.pdf_values_dir = pdf_values_dir
            self.save_pdf_values = False
        self.quadrature_fn = quadrature_fn
        os.makedirs(self.pdf_values_dir, exist_ok=True)
    def compute(self, bins: np.ndarray, alpha: np.ndarray):
        pdf_values_file = '{}/{}'.format(
            self.pdf_values_dir,
            f'simpsons_rule_pdf_values_alpha_{alpha.item()}_bin_size_{len(bins)}.pt'
        )
        # for Simpson's Rule
        num_divisions = 2 * (bins.shape[0] - 1) + 1
        # If not loading pdf_values, do quadrature even if pdf_values is set
        if not (self.load_pdf_values and self.pdf_values):
            # area = estimate_integral(bins[-1], alpha.item(), lambda x: self.quadrature_fn(x, alpha))
            # print(area)
            # import pdb; pdb.set_trace()
            self.pdf_values = get_2d_pdf(
                max_sample=bins[-1],
                alpha=alpha,
                num_divisions=num_divisions,
                quadrature_fn=self.quadrature_fn,
            )
        else:
            self.pdf_values = torch.load(pdf_values_file)
            self.pdf_values_map[len(bins)] = self.pdf_values
        if self.save_pdf_values:
            torch.save(self.pdf_values, pdf_values_file)
        keys = np.array(list(self.pdf_values.keys())).squeeze()
        values = np.array(list(self.pdf_values.values())).squeeze()
        copy_idx = np.arange(2, len(values)-2, 2)
        copied_keys = np.insert(keys, copy_idx, keys[copy_idx])
        copied_values = np.insert(values, copy_idx, values[copy_idx])
        x_grid = einops.rearrange(copied_keys, '(d c) -> c d', c=3)
        pdf_values = einops.rearrange(copied_values, '(d c) -> c d', c=3)
        return pdf_values, x_grid
    def get_pdf_map(self, num_bins: int):
        try:
            return self.pdf_values_map[num_bins]
        except Exception as e:
            print(f'WARNING: Simpsons Rule pdf values not avaiable for {num_bins} bins')
            return self.pdf_values

class TrapezoidCalculator(AnalyticalCalculator):
    def compute(self, bins: np.ndarray, alpha: np.ndarray):
        pdf_values = get_bm_pdf_map(alpha)
        x_vals = torch.tensor(list(pdf_values.keys()))  # D
        copied_x_vals = einops.repeat(x_vals, 'w -> b w', b=bins.shape[0])  # D x B
        copied_bins = einops.repeat(bins, 'b -> b w', w=x_vals.shape[0])  # D x B
        idxs = (copied_x_vals.numpy() <= copied_bins).astype(int).sum(1)  # D
        assert (idxs > 0).all(), "smallest bin outside discretized domain"
        assert (idxs < x_vals.shape[0]-1).all(), "largest bin outside discretized domain"
        values = torch.tensor(list(pdf_values.values()))  # D
        height = (values[1:] + values[:-1]) / 2  # D-1
        areas = x_vals.diff() * height  # D-1
        cum_areas = areas.cumsum(dim=0)
        output = cum_areas[idxs[1:]+1] - cum_areas[idxs[:-1]-1]  # B-1
        return output.numpy()

#########################
### /Prop Calculator ####
#########################

def get_bm_pdf_map(alpha: np.ndarray):
    pdf_values_alpha_0_0 = {
        0.0: 0.0,
        0.040268456375838924: 0.040235820978447426,
        0.08053691275167785: 0.08027614679342408,
        0.12080536912751677: 0.1199270645195413,
        0.1610738255033557: 0.1589978078105654,
        0.20134228187919462: 0.1973022856219711,
        0.24161073825503354: 0.23466055827517382,
        0.28187919463087246: 0.2709002443660931,
        0.3221476510067114: 0.3058578432408727,
        0.3624161073825503: 0.3393799588059722,
        0.40268456375838924: 0.37132441196943494,
        0.44295302013422816: 0.4015612304687911,
        0.4832214765100671: 0.4299735066611312,
        0.523489932885906: 0.4564581156606108,
        0.5637583892617449: 0.4809262880933769,
        0.6040268456375839: 0.5033040336928464,
        0.6442953020134228: 0.5235324140886747,
        0.6845637583892616: 0.5415676647769702,
        0.7248322147651006: 0.5573811687491711,
        0.7651006711409396: 0.570959285316641,
        0.8053691275167785: 0.5823030403106536,
        0.8456375838926173: 0.5914276846290188,
        0.8859060402684563: 0.5983621301802137,
        0.9261744966442953: 0.6031482732229801,
        0.9664429530201342: 0.6058402163376488,
        1.006711409395973: 0.6065034011673411,
        1.046979865771812: 0.6052136647863923,
        1.087248322147651: 0.6020562330106852,
        1.1275167785234899: 0.597124664302614,
        1.1677852348993287: 0.5905197579829717,
        1.2080536912751678: 0.5823484403961138,
        1.2483221476510067: 0.5727226422597242,
        1.2885906040268456: 0.5617581800512826,
        1.3288590604026844: 0.5495736536956787,
        1.3691275167785233: 0.5362893718686956,
        1.4093959731543624: 0.5220263153613764,
        1.4496644295302012: 0.5069051481676363,
        1.4899328859060401: 0.4910452844968668,
        1.5302013422818792: 0.47456401910345236,
        1.570469798657718: 0.45757572684355474,
        1.610738255033557: 0.44019113629750817,
        1.6510067114093958: 0.4225166813101789,
        1.6912751677852347: 0.4046539324175218,
        1.7315436241610738: 0.3866991098797877,
        1.7718120805369126: 0.36874267823196355,
        1.8120805369127515: 0.35086902157058547,
        1.8523489932885906: 0.33315619773901856,
        1.8926174496644295: 0.3156757687524357,
        1.9328859060402683: 0.2984927039899244,
        1.9731543624161072: 0.281665352054154,
        2.013422818791946: 0.26524547661960446,
        2.053691275167785: 0.24927835114220448,
        2.093959731543624: 0.23380290688704622,
        2.134228187919463: 0.21885192876158444,
        2.174496644295302: 0.20445229271374057,
        2.2147651006711406: 0.19062523915045426,
        2.2550335570469797: 0.17738667623950502,
        2.295302013422819: 0.16474750739959446,
        2.3355704697986575: 0.15271397740669132,
        2.3758389261744965: 0.14128803167864243,
        2.4161073825503356: 0.13046768381284968,
        2.4563758389261743: 0.12024738656560575,
        2.4966442953020134: 0.11061840200883274,
        2.536912751677852: 0.10156916691537357,
        2.577181208053691: 0.0930856499073112,
        2.61744966442953: 0.08515169737985816,
        2.657718120805369: 0.07774936466095421,
        2.697986577181208: 0.07085923307898699,
        2.7382550335570466: 0.06446070626976398,
        2.7785234899328857: 0.05853228924108603,
        2.8187919463087248: 0.053051846223420365,
        2.8590604026845634: 0.0479968376385699,
        2.8993288590604025: 0.04334453571117889,
        2.9395973154362416: 0.039072218687514045,
        2.9798657718120802: 0.035157343890404986,
        3.0201342281879193: 0.031577700075584456,
        3.0604026845637584: 0.028311539754427063,
        3.100671140939597: 0.025337692317756386,
        3.140939597315436: 0.022635658938731984,
        3.181208053691275: 0.020185690338659946,
        3.221476510067114: 0.017968848585535168,
        3.261744966442953: 0.015967054152531003,
        3.3020134228187916: 0.014163119494585142,
        3.3422818791946307: 0.012540770416745504,
        3.3825503355704694: 0.01108465650002376,
        3.4228187919463084: 0.00978035182670303,
        3.4630872483221475: 0.008614347212666571,
        3.503355704697986: 0.007574035102647425,
        3.5436241610738253: 0.006647688227485302,
        3.5838926174496644: 0.005824433056079342,
        3.624161073825503: 0.005094219003490905,
        3.664429530201342: 0.004447784281333602,
        3.704697986577181: 0.003876619199388858,
        3.74496644295302: 0.0033729276496276073,
        3.785234899328859: 0.0029295874263103355,
        3.8255033557046976: 0.0025401099604428065,
        3.8657718120805367: 0.002198599973675523,
        3.9060402684563758: 0.0018997154871635317,
        3.9463087248322144: 0.001638628555083397,
        3.9865771812080535: 0.0014109870310776253,
        4.026845637583892: 0.0012128776191095393,
        4.067114093959732: 0.0010407904082829944,
        4.10738255033557: 0.0008915850440827838,
        4.147651006711409: 0.0007624586463640139,
        4.187919463087248: 0.0006509155470306258,
        4.228187919463087: 0.0005547388876032958,
        4.268456375838926: 0.0004719640885611253,
        4.308724832214764: 0.0004008541782184283,
        4.348993288590604: 0.0003398769486142873,
        4.389261744966443: 0.0002876838892512443,
        4.429530201342281: 0.00024309083613171728,
        4.469798657718121: 0.00020506026310091176,
        4.510067114093959: 0.00017268513472208427,
        4.550335570469798: 0.00014517423445862792,
        4.590604026845638: 0.00012183887851724034,
        4.630872483221476: 0.0001020809240404546,
        4.671140939597315: 8.538198017535864e-05,
        4.7114093959731544: 7.129373160714272e-05,
        4.751677852348993: 5.942928625450047e-05,
        4.791946308724832: 4.945546172942466e-05,
        4.832214765100671: 4.108592872098896e-05,
        4.87248322147651: 3.407513348806968e-05,
        4.912751677852349: 2.8212926003801955e-05,
        4.953020134228187: 2.3319824869697417e-05,
        4.993288590604027: 1.9242854794417404e-05,
        5.033557046979865: 1.5851897130605282e-05,
        5.073825503355704: 1.3036498610026512e-05,
        5.114093959731544: 1.070308794923924e-05,
        5.154362416107382: 8.77255437559881e-06,
        5.194630872483221: 7.178146304923671e-06,
        5.23489932885906: 5.86365236581295e-06,
        5.275167785234899: 4.781830692537985e-06,
        5.315436241610738: 3.893055887864665e-06,
        5.355704697986577: 3.16415628501877e-06,
        5.395973154362416: 2.5674171149207466e-06,
        5.4362416107382545: 2.079727913874272e-06,
        5.476510067114093: 1.681854997373345e-06,
        5.516778523489933: 1.3578220855625928e-06,
        5.557046979865771: 1.0943842082439944e-06,
        5.59731543624161: 8.805818542247288e-07,
        5.6375838926174495: 7.07363975095216e-07,
        5.677852348993288: 5.672699212952326e-07,
        5.718120805369127: 4.5416169245977444e-07,
        5.758389261744966: 3.629990385338891e-07,
        5.798657718120805: 2.8965096635982914e-07,
        5.838926174496644: 2.3073810137173082e-07,
        5.879194630872483: 1.8302693077488562e-07,
        5.919463087248322: 1.4531479700179725e-07,
        5.9597315436241605: 1.1505725923049881e-07,
        6.0: 9.090758895169395e-08,
    }
    pdf_values_alpha_0_5 = {
        0.5: 0.0,
        0.5369127516778524: 0.22074309412743273,
        0.5738255033557047: 0.3178242323500742,
        0.610738255033557: 0.3947273367257175,
        0.6476510067114094: 0.4605217716120231,
        0.6845637583892618: 0.5184694408676893,
        0.7214765100671141: 0.5561486659515757,
        0.7583892617449665: 0.5688516363554791,
        0.7953020134228188: 0.579675977143711,
        0.8322147651006712: 0.5886311938107796,
        0.8691275167785235: 0.5957365469192419,
        0.9060402684563759: 0.601020634436361,
        0.9429530201342282: 0.6045209116284761,
        0.9798657718120806: 0.606283154966425,
        1.016778523489933: 0.6063608767842862,
        1.0536912751677852: 0.6048146979298479,
        1.0906040268456376: 0.6017116856681314,
        1.12751677852349: 0.5971246643602756,
        1.1644295302013423: 0.5911315059911246,
        1.2013422818791946: 0.5838144091452593,
        1.238255033557047: 0.5752591715937206,
        1.2751677852348995: 0.5655544655824382,
        1.3120805369127517: 0.5547911212409844,
        1.348993288590604: 0.5430614248282296,
        1.3859060402684564: 0.5304584375675854,
        1.422818791946309: 0.5170753405814853,
        1.4597315436241611: 0.5030048105836773,
        1.4966442953020134: 0.48833843077064915,
        1.5335570469798658: 0.4731661404843705,
        1.5704697986577183: 0.4575757268310958,
        1.6073825503355705: 0.4416523606852564,
        1.6442953020134228: 0.4254781789857734,
        1.6812080536912752: 0.4091319146153588,
        1.7181208053691277: 0.39268857456447137,
        1.75503355704698: 0.3762191665591169,
        1.7919463087248322: 0.35979047378972556,
        1.8288590604026846: 0.34346487688324195,
        1.865771812080537: 0.32730022185791324,
        1.9026845637583893: 0.311349732333675,
        1.9395973154362416: 0.29566196397295286,
        1.976510067114094: 0.28028079877779444,
        2.0134228187919465: 0.2652454766196086,
        2.050335570469799: 0.2505906611694399,
        2.087248322147651: 0.2363465371388228,
        2.1241610738255035: 0.2225389362869226,
        2.161073825503356: 0.20918948728504888,
        2.197986577181208: 0.19631578906303893,
        2.2348993288590604: 0.18393160157901395,
        2.271812080536913: 0.17204705255284541,
        2.3087248322147653: 0.16066885650325968,
        2.345637583892618: 0.14980054319813654,
        2.38255033557047: 0.1394426926870413,
        2.4194630872483223: 0.12959317422098743,
        2.4563758389261747: 0.12024738656555037,
        2.4932885906040267: 0.11139849741154773,
        2.530201342281879: 0.10303767975971086,
        2.5671140939597317: 0.0951543433976272,
        2.604026845637584: 0.08773635978863896,
        2.6409395973154366: 0.08077027890781499,
        2.6778523489932886: 0.07424153677988204,
        2.714765100671141: 0.06813465267749126,
        2.7516778523489935: 0.06243341514513863,
        2.7885906040268456: 0.05712105620807387,
        2.825503355704698: 0.052180413291335895,
        2.8624161073825505: 0.047594078586998656,
        2.899328859060403: 0.0433445357112182,
        2.9362416107382554: 0.039414283678613264,
        2.9731543624161074: 0.035785948333478854,
        3.01006711409396: 0.032442381495333204,
        3.0469798657718123: 0.029366748176794924,
        3.0838926174496644: 0.026542602320106627,
        3.120805369127517: 0.02395395156770404,
        3.1577181208053693: 0.021585311642673657,
        3.1946308724832218: 0.019421750960752684,
        3.231543624161074: 0.01744892612861769,
        3.2684563758389262: 0.0156531090052388,
        3.3053691275167787: 0.01402120601681849,
        3.342281879194631: 0.012540770416738059,
        3.379194630872483: 0.011200008178587384,
        3.4161073825503356: 0.009987778195022208,
        3.453020134228188: 0.008893587439358277,
        3.4899328859060406: 0.007907581719252753,
        3.526845637583893: 0.007020532625066654,
        3.563758389261745: 0.006223821242319966,
        3.6006711409395975: 0.0055094191627779315,
        3.63758389261745: 0.004869867291686978,
        3.674496644295302: 0.004298252910499436,
        3.7114093959731544: 0.0037881854156647833,
        3.748322147651007: 0.003333771115174846,
        3.7852348993288594: 0.002929587426310137,
        3.822147651006712: 0.002570656780493379,
        3.859060402684564: 0.0022524205051464175,
        3.8959731543624163: 0.001970712917643214,
        3.9328859060402688: 0.0017217358338453164,
        3.969798657718121: 0.0015020336627467451,
        4.006711409395973: 0.0013084692301263026,
        4.043624161073826: 0.0011382004475395315,
        4.080536912751678: 0.0009886579187697727,
        4.117449664429531: 0.0008575235537640109,
        4.154362416107382: 0.0007427102402997643,
        4.191275167785236: 0.0006423426059871925,
        4.228187919463087: 0.0005547388876032958,
        4.26510067114094: 0.0004783939112140177,
        4.302013422818792: 0.00041196317483131165,
        4.3389261744966445: 0.00035424801542240395,
        4.375838926174497: 0.0003041818337801907,
        4.4127516778523495: 0.00026081734399045775,
        4.449664429530202: 0.0002233148087734081,
        4.4865771812080535: 0.00019093121782453294,
        4.523489932885906: 0.00016301036316180933,
        4.560402684563758: 0.00013897376341681883,
        4.597315436241611: 0.00011831238773967126,
        4.634228187919463: 0.00010057912951057319,
        4.671140939597316: 8.538198017530995e-05,
        4.708053691275168: 7.237785421487164e-05,
        4.744966442953021: 6.126701737534678e-05,
        4.781879194630873: 5.178807177505187e-05,
        4.818791946308725: 4.3713453282420584e-05,
        4.855704697986577: 3.6845398548661654e-05,
        4.89261744966443: 3.101234123576808e-05,
        4.929530201342282: 2.6065699240384638e-05,
        4.966442953020135: 2.1877017037258568e-05,
        5.003355704697987: 1.8335429609273428e-05,
        5.0402684563758395: 1.534541676875486e-05,
        5.077181208053691: 1.2824818969709065e-05,
        5.114093959731544: 1.070308794923924e-05,
        5.151006711409396: 8.919747695930195e-06,
        5.1879194630872485: 7.423043311294346e-06,
        5.224832214765101: 6.168757296801433e-06,
        5.261744966442953: 5.119174657857414e-06,
        5.298657718120806: 4.242179960765963e-06,
        5.335570469798658: 3.5104711090519526e-06,
        5.372483221476511: 2.9008761206259457e-06,
        5.409395973154362: 2.3937605884983315e-06,
        5.446308724832215: 1.972514798024172e-06,
        5.483221476510067: 1.6231106568464179e-06,
        5.52013422818792: 1.3337196740874132e-06,
        5.557046979865772: 1.0943842082453178e-06,
        5.593959731543625: 8.967350940835438e-07,
        5.630872483221477: 7.337495635438607e-07,
        5.667785234899329: 5.995440998254914e-07,
        5.704697986577181: 4.891975137150789e-07,
        5.741610738255034: 3.98600112296143e-07,
        5.778523489932886: 3.243253483622691e-07,
        5.815436241610739: 2.6352079941597895e-07,
        5.852348993288591: 2.1381573341334485e-07,
        5.8892617449664435: 1.7279518175160378e-07,
        5.926174496644296: 1.3981010176598367e-07,
        5.963087248322148: 1.1284194083684488e-07,
        6.0: 9.090758895169395e-08,
    }
    pdf_values_alpha_1_0 = {
        1.0: 0.0,
        1.0335570469798658: 0.1971064789818423,
        1.0671140939597314: 0.27413701896532433,
        1.1006711409395973: 0.32961323176142016,
        1.1342281879194631: 0.37301137013940205,
        1.167785234899329: 0.40803506376463755,
        1.2013422818791946: 0.4366114146856917,
        1.2348993288590604: 0.45991234642800355,
        1.2684563758389262: 0.47872838493741093,
        1.302013422818792: 0.4936351509302721,
        1.3355704697986577: 0.5050775790520675,
        1.3691275167785235: 0.5134162706899298,
        1.4026845637583891: 0.5189549570623297,
        1.436241610738255: 0.512033476069409,
        1.4697986577181208: 0.4990601630631042,
        1.5033557046979866: 0.48561485848201236,
        1.5369127516778525: 0.4717648080909799,
        1.570469798657718: 0.45757572684355474,
        1.604026845637584: 0.4431115145462571,
        1.6375838926174495: 0.42843399792115194,
        1.6711409395973154: 0.4136026992907605,
        1.7046979865771812: 0.39867463270139597,
        1.738255033557047: 0.3837041273461478,
        1.7718120805369129: 0.3687426782344517,
        1.8053691275167785: 0.35383882376090897,
        1.8389261744966443: 0.3390380496036686,
        1.87248322147651: 0.32438271813496294,
        1.9060402684563758: 0.3099120224676436,
        1.9395973154362416: 0.29566196397295286,
        1.9731543624161074: 0.2816653520538724,
        2.0067114093959733: 0.26795182479603213,
        2.0402684563758386: 0.2545478890425404,
        2.073825503355705: 0.24147697833374454,
        2.1073825503355703: 0.22875952719211395,
        2.140939597315436: 0.2164130599552434,
        2.174496644295302: 0.20445229271374057,
        2.208053691275168: 0.19288924653229092,
        2.2416107382550337: 0.18173337041293736,
        2.275167785234899: 0.17099167223416178,
        2.3087248322147653: 0.16066885650325968,
        2.3422818791946307: 0.15076746673045324,
        2.3758389261744965: 0.14128803167864243,
        2.4093959731543624: 0.13222921366113755,
        2.442953020134228: 0.12358795778838218,
        2.476510067114094: 0.11535964091756913,
        2.5100671140939594: 0.10753821919974808,
        2.5436241610738257: 0.10011637323463962,
        2.577181208053691: 0.0930856499073112,
        2.610738255033557: 0.0864366001109738,
        2.6442953020134228: 0.08015891166491772,
        2.6778523489932886: 0.07424153677988204,
        2.7114093959731544: 0.06867281361050044,
        2.74496644295302: 0.06344058144824487,
        2.778523489932886: 0.05853228923932239,
        2.8120805369127515: 0.05393509719573469,
        2.845637583892618: 0.04963597130664644,
        2.879194630872483: 0.045621770723822834,
        2.912751677852349: 0.04187932794535682,
        2.946308724832215: 0.038395521880580236,
        2.9798657718120802: 0.035157343890404986,
        3.0134228187919465: 0.032151956955723,
        3.046979865771812: 0.029366748176718395,
        3.0805369127516777: 0.026789374839301286,
        3.1140939597315436: 0.02440780431771261,
        3.1476510067114094: 0.022210348112306304,
        3.1812080536912752: 0.020185690338647637,
        3.214765100671141: 0.01832291100365054,
        3.248322147651007: 0.0166115044137006,
        3.2818791946308723: 0.015041393068026633,
        3.315436241610738: 0.013602937391995263,
        3.348993288590604: 0.01228694166619531,
        3.38255033557047: 0.011084656500020332,
        3.4161073825503356: 0.009987778195022208,
        3.4496644295302015: 0.008988445330303,
        3.4832214765100673: 0.008079232892565695,
        3.5167785234899327: 0.00725314425875305,
        3.5503355704697985: 0.006503601324646314,
        3.5838926174496644: 0.005824433056079342,
        3.61744966442953: 0.005209862722658616,
        3.651006711409396: 0.004654494055904622,
        3.684563758389262: 0.004153296555863848,
        3.7181208053691277: 0.00370159015193937,
        3.751677852348993: 0.0032950294057955366,
        3.785234899328859: 0.0029295874263103355,
        3.8187919463087248: 0.002601539649277993,
        3.8523489932885906: 0.0023074476178307217,
        3.8859060402684564: 0.0020441428833855354,
        3.9194630872483223: 0.0018087111317283153,
        3.953020134228188: 0.001598476624279979,
        3.9865771812080535: 0.0014109870310776253,
        4.020134228187919: 0.0012439987193101113,
        4.053691275167785: 0.0010954625495775692,
        4.087248322147651: 0.0009635102212664858,
        4.120805369127517: 0.0008464411986265204,
        4.154362416107382: 0.0007427102402997643,
        4.1879194630872485: 0.0006509155470317784,
        4.221476510067114: 0.0005697875352629928,
        4.25503355704698: 0.0004981782380152857,
        4.2885906040268456: 0.0004350513290387064,
        4.322147651006711: 0.00037947276150405827,
        4.355704697986577: 0.00033060200849982984,
        4.3892617449664435: 0.0002876838892513248,
        4.422818791946309: 0.00025004096221987586,
        4.456375838926174: 0.00021706646405406348,
        4.48993288590604: 0.00018821777162786248,
        4.523489932885906: 0.00016301036316180933,
        4.557046979865772: 0.00014101225355122313,
        4.590604026845638: 0.00012183887851724034,
        4.624161073825503: 0.00010514840199895613,
        4.657718120805369: 9.063742127080531e-05,
        4.691275167785236: 7.803704456830412e-05,
        4.724832214765101: 6.710931649893048e-05,
        4.758389261744966: 5.7643967167415414e-05,
        4.791946308724832: 4.945546172942466e-05,
        4.825503355704698: 4.23803279773518e-05,
        4.859060402684564: 3.627474053169277e-05,
        4.89261744966443: 3.101234123576808e-05,
        4.926174496644295: 2.6482276420990675e-05,
        4.9597315436241605: 2.2587432794009275e-05,
        4.993288590604027: 1.9242854794417404e-05,
        5.026845637583893: 1.6374327360940513e-05,
        5.060402684563758: 1.3917109118250379e-05,
        5.093959731543624: 1.181480204696572e-05,
        5.12751677852349: 1.0018344717546288e-05,
        5.1610738255033555: 8.485117150530007e-06,
        5.194630872483222: 7.1781463049196366e-06,
        5.228187919463087: 6.065402091766982e-06,
        5.261744966442953: 5.119174657857414e-06,
        5.295302013422819: 4.315524484066256e-06,
        5.328859060402684: 3.6337975935414873e-06,
        5.3624161073825505: 3.0561988668617874e-06,
        5.395973154362416: 2.5674171149207466e-06,
        5.429530201342282: 2.154296166697593e-06,
        5.4630872483221475: 1.8055467899416558e-06,
        5.496644295302014: 1.5114947794260324e-06,
        5.530201342281879: 1.263861022132232e-06,
        5.563758389261745: 1.055569783314375e-06,
        5.597315436241611: 8.805818542251972e-07,
        5.630872483221476: 7.337495635434984e-07,
        5.6644295302013425: 6.106909825036127e-07,
        5.697986577181208: 5.076809506844251e-07,
        5.731543624161074: 4.2155681760833993e-07,
        5.76510067114094: 3.4963703683891593e-07,
        5.798657718120805: 2.8965096635982914e-07,
        5.832214765100671: 2.3967842358264594e-07,
        5.865771812080537: 1.9809771735592863e-07,
        5.899328859060403: 1.6311840883241286e-07,
        5.932885906040268: 1.3436334757963178e-07,
        5.966442953020135: 1.1066799503841598e-07,
        6.0: 9.090758895169395e-08,
    }
    pdf_values_alpha_1_5 = {
        1.5: 0.0,
        1.5302013422818792: 0.12024739006202956,
        1.5604026845637584: 0.16415730030299078,
        1.5906040268456376: 0.19385465201939767,
        1.6208053691275168: 0.2155861324101746,
        1.651006711409396: 0.23187813417640904,
        1.6812080536912752: 0.24408820597265973,
        1.7114093959731544: 0.25306516953495534,
        1.7416107382550337: 0.2593180228691403,
        1.7718120805369129: 0.26350522698929757,
        1.802013422818792: 0.26573355839055524,
        1.8322147651006713: 0.26634771750548814,
        1.8624161073825505: 0.26557004575616266,
        1.8926174496644297: 0.26359098287667887,
        1.9228187919463087: 0.2605720061813656,
        1.9530201342281879: 0.25665619946640444,
        1.983221476510067: 0.25196964067599364,
        2.0134228187919465: 0.24662466128960592,
        2.0436241610738257: 0.24072200435425137,
        2.073825503355705: 0.23435238277021261,
        2.104026845637584: 0.22759772551793678,
        2.1342281879194633: 0.21885192876170906,
        2.1644295302013425: 0.207999258266824,
        2.1946308724832218: 0.19746607762055726,
        2.224832214765101: 0.18725991858376262,
        2.25503355704698: 0.1773866762580063,
        2.2852348993288594: 0.16785068863062846,
        2.315436241610738: 0.15865481947245144,
        2.3456375838926173: 0.14980054319694713,
        2.3758389261744965: 0.14128803167864243,
        2.4060402684563758: 0.13311624198030997,
        2.436241610738255: 0.12528300451505633,
        2.466442953020134: 0.11778511104693881,
        2.4966442953020134: 0.11061840200883274,
        2.5268456375838926: 0.10377785263226673,
        2.557046979865772: 0.09725765747737179,
        2.587248322147651: 0.09105131291679004,
        2.61744966442953: 0.08515169737985816,
        2.6476510067114094: 0.0795511480634315,
        2.6778523489932886: 0.07424153677988204,
        2.708053691275168: 0.069214339774579,
        2.738255033557047: 0.06446070626987357,
        2.7684563758389262: 0.059971522607869934,
        2.7986577181208054: 0.055737472871606554,
        2.8288590604026846: 0.05174909575541958,
        2.859060402684564: 0.04799683763853437,
        2.889261744966443: 0.044471101843183175,
        2.9194630872483223: 0.041162294085921154,
        2.9496644295302015: 0.03806086415742805,
        2.9798657718120807: 0.035157343890471204,
        3.01006711409396: 0.032442381495333204,
        3.040268456375839: 0.02990677236059102,
        3.0704697986577183: 0.027541486435004387,
        3.1006711409395975: 0.025337692317759616,
        3.1308724832214763: 0.023286778198805955,
        3.1610738255033555: 0.021380369798418692,
        3.1912751677852347: 0.01961034546365029,
        3.221476510067114: 0.017968848585535168,
        3.251677852348993: 0.016448297503699135,
        3.2818791946308723: 0.015041393068026633,
        3.3120805369127515: 0.013741124027617685,
        3.3422818791946307: 0.012540770416745504,
        3.37248322147651: 0.011433905104516019,
        3.402684563758389: 0.01041439367395039,
        3.4328859060402683: 0.009476392790064953,
        3.4630872483221475: 0.008614347212666571,
        3.4932885906040267: 0.007822985603826646,
        3.523489932885906: 0.007097315273527351,
        3.553691275167785: 0.006432616000230744,
        3.5838926174496644: 0.005824433056079342,
        3.6140939597315436: 0.005268569558812994,
        3.6442953020134228: 0.004761078264887839,
        3.674496644295302: 0.004298252910499436,
        3.704697986577181: 0.003876619199388858,
        3.7348993288590604: 0.0034929255285201656,
        3.7651006711409396: 0.0031441335350369634,
        3.795302013422819: 0.0028274085404326734,
        3.825503355704698: 0.0025401099604418394,
        3.8557046979865772: 0.0022797817422066935,
        3.8859060402684564: 0.0020441428833855354,
        3.9161073825503356: 0.0018310780814248496,
        3.946308724832215: 0.0016386285550847005,
        3.976510067114094: 0.0014649830744285807,
        4.006711409395973: 0.0013084692301263026,
        4.0369127516778525: 0.00116754496777681,
        4.067114093959732: 0.0010407904082829944,
        4.097315436241611: 0.000926899970942195,
        4.12751677852349: 0.0008246748119717034,
        4.157718120805369: 0.0007330155875278156,
        4.1879194630872485: 0.0006509155470317784,
        4.218120805369128: 0.000577453959668392,
        4.248322147651007: 0.0005117898743013644,
        4.278523489932886: 0.0004531562107317661,
        4.308724832214765: 0.00040085417821897394,
        4.3389261744966445: 0.00035424801542240395,
        4.369127516778524: 0.0003127600444214657,
        4.399328859060403: 0.0002758660302246821,
        4.429530201342282: 0.0002430908361316686,
        4.459731543624161: 0.00021400436447741535,
        4.489932885906041: 0.00018821777162766632,
        4.52013422818792: 0.00016537994561498486,
        4.550335570469799: 0.00014517423445855685,
        4.580536912751678: 0.00012731541301278646,
        4.610738255033557: 0.00011154687610188508,
        4.640939597315437: 9.763804571872833e-05,
        4.671140939597316: 8.538198017530995e-05,
        4.701342281879195: 7.459317328504863e-05,
        4.731543624161073: 6.510553190841245e-05,
        4.7617449664429525: 5.677052050995134e-05,
        4.791946308724832: 4.945546172942466e-05,
        4.822147651006711: 4.304198236578796e-05,
        4.85234899328859: 3.742459459707403e-05,
        4.882550335570469: 3.2509402701005114e-05,
        4.912751677852349: 2.8212926003801955e-05,
        4.942953020134228: 2.4461029250266575e-05,
        4.973154362416107: 2.118795206046448e-05,
        5.003355704697986: 1.8335429609274905e-05,
        5.033557046979865: 1.5851897130605282e-05,
        5.063758389261745: 1.3691771306409795e-05,
        5.093959731543624: 1.181480204696572e-05,
        5.124161073825503: 1.0185488603886876e-05,
        5.154362416107382: 8.77255437559881e-06,
        5.184563758389261: 7.548475168180033e-06,
        5.214765100671141: 6.4890560597078775e-06,
        5.24496644295302: 5.57305238330309e-06,
        5.275167785234899: 4.781830692537985e-06,
        5.305369127516778: 4.099065902355042e-06,
        5.3355704697986575: 3.51047110905001e-06,
        5.365771812080537: 3.0035568847885278e-06,
        5.395973154362416: 2.5674171149207466e-06,
        5.426174496644295: 2.192538701804716e-06,
        5.456375838926174: 1.8706326960075942e-06,
        5.4865771812080535: 1.5944846364936124e-06,
        5.516778523489933: 1.3578220855625928e-06,
        5.546979865771812: 1.1551975330486265e-06,
        5.577181208053691: 9.818850182270285e-07,
        5.60738255033557: 8.337889778041691e-07,
        5.6375838926174495: 7.07363975095216e-07,
        5.667785234899329: 5.995440998254914e-07,
        5.697986577181208: 5.076809506844251e-07,
        5.728187919463087: 4.2948922460889785e-07,
        5.758389261744966: 3.629990385338891e-07,
        5.7885906040268456: 3.065142017035698e-07,
        5.818791946308725: 2.585757403785578e-07,
        5.848993288590604: 2.179300524468565e-07,
        5.879194630872483: 1.8302693077488562e-07,
        5.909395973154362: 1.5396749547503126e-07,
        5.939597315436242: 1.292615297039356e-07,
        5.969798657718121: 1.0853467466628778e-07,
        6.0: 9.090758895169395e-08,
    }
    pdf_values_alpha_2_0 = {
        2.0: 0.0,
        2.0268456375838926: 0.053927695474142175,
        2.053691275167785: 0.07273521004187324,
        2.0805369127516777: 0.08491226364432837,
        2.1073825503355703: 0.09338155453981621,
        2.134228187919463: 0.09935273583740194,
        2.1610738255033555: 0.10348508878058194,
        2.1879194630872485: 0.10619479582489988,
        2.214765100671141: 0.10776980486336828,
        2.2416107382550337: 0.10842217450409079,
        2.2684563758389262: 0.10831522353320268,
        2.295302013422819: 0.10757895617937155,
        2.3221476510067114: 0.10628842544847497,
        2.348993288590604: 0.10462509567891692,
        2.3758389261744965: 0.10257032101185662,
        2.402684563758389: 0.10021880546081137,
        2.4295302013422817: 0.09762536893540828,
        2.4563758389261743: 0.09483753413721244,
        2.4832214765100673: 0.0918965172966217,
        2.51006711409396: 0.08883901736314004,
        2.5369127516778525: 0.08569617576269135,
        2.563758389261745: 0.08249591838640276,
        2.5906040268456376: 0.07926255149911972,
        2.61744966442953: 0.07601734483970396,
        2.6442953020134228: 0.07277886370930522,
        2.6711409395973154: 0.06956325693325932,
        2.697986577181208: 0.0663845174847353,
        2.7248322147651005: 0.06325469641812324,
        2.751677852348993: 0.06018409661418227,
        2.778523489932886: 0.05718145551640444,
        2.8053691275167782: 0.054254086108628315,
        2.8322147651006713: 0.051320693312083256,
        2.859060402684564: 0.04799683763853437,
        2.8859060402684564: 0.044851962526051684,
        2.912751677852349: 0.04187932794535682,
        2.9395973154362416: 0.039072218687514045,
        2.966442953020134: 0.036423965773176005,
        2.9932885906040267: 0.03392796605727799,
        3.0201342281879198: 0.0315777000756673,
        3.046979865771812: 0.029366748176718395,
        3.073825503355705: 0.02728880499408095,
        3.100671140939597: 0.025337692317756386,
        3.12751677852349: 0.023507370427524547,
        3.154362416107382: 0.021791947954229035,
        3.1812080536912752: 0.020185690338647637,
        3.208053691275168: 0.018683026959559423,
        3.2348993288590604: 0.0172785570037376,
        3.261744966442953: 0.015967054152531003,
        3.2885906040268456: 0.014743470159236481,
        3.315436241610738: 0.013602937391995263,
        3.3422818791946307: 0.012540770416745504,
        3.3691275167785237: 0.011552466691925984,
        3.395973154362416: 0.010633706448887472,
        3.422818791946309: 0.009780351826690181,
        3.449664429530201: 0.0089884453303039,
        3.476510067114094: 0.008254207678107492,
        3.5033557046979866: 0.007574035102650666,
        3.530201342281879: 0.006944496165740243,
        3.557046979865772: 0.006362328146204488,
        3.5838926174496644: 0.005824433056079342,
        3.610738255033557: 0.005327873337752523,
        3.6375838926174495: 0.004869867291685745,
        3.6644295302013425: 0.004447784281332302,
        3.6912751677852347: 0.004059139758839221,
        3.7181208053691277: 0.00370159015193937,
        3.74496644295302: 0.0033729276496276073,
        3.771812080536913: 0.0030710749211037944,
        3.7986577181208054: 0.002794079799680823,
        3.825503355704698: 0.0025401099604418394,
        3.8523489932885906: 0.0023074476178307217,
        3.879194630872483: 0.0020944842666028502,
        3.9060402684563758: 0.0018997154871635317,
        3.9328859060402683: 0.0017217358338449344,
        3.9597315436241614: 0.0015592338224303594,
        3.9865771812080535: 0.0014109870310776253,
        4.0134228187919465: 0.0012758573267547474,
        4.0402684563758395: 0.0011527862274015239,
        4.067114093959732: 0.0010407904082829944,
        4.093959731543624: 0.0009389573593087728,
        4.120805369127517: 0.0008464411986265204,
        4.14765100671141: 0.0007624586463644767,
        4.174496644295302: 0.0006862851611343593,
        4.201342281879194: 0.0006172512407573002,
        4.228187919463087: 0.0005547388876032958,
        4.25503355704698: 0.0004981782380152857,
        4.281879194630872: 0.00044704435445149285,
        4.308724832214764: 0.0004008541782184283,
        4.3355704697986575: 0.0003591636400506351,
        4.3624161073825505: 0.00032156492520120594,
        4.3892617449664435: 0.0002876838892513248,
        4.416107382550336: 0.000257177620424394,
        4.442953020134228: 0.0002297321438702092,
        4.469798657718121: 0.00020506026310091176,
        4.496644295302014: 0.00018289953356271095,
        4.523489932885906: 0.00016301036316180933,
        4.550335570469798: 0.00014517423445862792,
        4.577181208053691: 0.0001291920431823628,
        4.604026845637584: 0.00011488254769489787,
        4.630872483221476: 0.0001020809240404546,
        4.657718120805369: 9.063742127080531e-05,
        4.684563758389261: 8.041611179503288e-05,
        4.7114093959731544: 7.129373160714272e-05,
        4.7382550335570475: 6.315860535449024e-05,
        4.76510067114094: 5.5909651343868885e-05,
        4.791946308724832: 4.945546172942466e-05,
        4.818791946308725: 4.3713453282420584e-05,
        4.845637583892618: 3.8609084313467804e-05,
        4.87248322147651: 3.407513348806968e-05,
        4.899328859060402: 3.0051036459319763e-05,
        4.926174496644295: 2.6482276420990675e-05,
        4.953020134228188: 2.3319824869723675e-05,
        4.979865771812081: 2.0519629047819975e-05,
        5.006711409395973: 1.8042142721710777e-05,
        5.033557046979865: 1.5851897130605282e-05,
        5.060402684563758: 1.3917109118250379e-05,
        5.087248322147651: 1.2209323632805628e-05,
        5.114093959731544: 1.070308794923924e-05,
        5.140939597315436: 9.375655131711214e-06,
        5.167785234899329: 8.206714411148172e-06,
        5.194630872483222: 7.1781463049196366e-06,
        5.221476510067114: 6.2738004512708015e-06,
        5.248322147651006: 5.479294269872825e-06,
        5.275167785234899: 4.781830692537985e-06,
        5.302013422818792: 4.170033334230614e-06,
        5.328859060402685: 3.6337975935393545e-06,
        5.355704697986577: 3.16415628501877e-06,
        5.382550335570469: 2.753158511963977e-06,
        5.409395973154362: 2.3937605884983315e-06,
        5.436241610738255: 2.079727913874228e-06,
        5.4630872483221475: 1.8055467899416558e-06,
        5.48993288590604: 1.5663452551922825e-06,
        5.516778523489933: 1.3578220855625928e-06,
        5.543624161073826: 1.1761831838357693e-06,
        5.570469798657718: 1.01808464594049e-06,
        5.597315436241611: 8.805818542251972e-07,
        5.624161073825503: 7.610840049190576e-07,
        5.651006711409396: 6.573135298521864e-07,
        5.677852348993289: 5.672699212948765e-07,
        5.704697986577181: 4.891975137150789e-07,
        5.731543624161073: 4.2155681760826957e-07,
        5.758389261744966: 3.629990385338891e-07,
        5.785234899328859: 3.1234344931257376e-07,
        5.8120805369127515: 2.685573152477054e-07,
        5.838926174496644: 2.3073810137173082e-07,
        5.865771812080537: 1.9809771735592863e-07,
        5.89261744966443: 1.6950939571177977e-07,
        5.919463087248323: 1.4531479700179532e-07,
        5.946308724832215: 1.2434766954009138e-07,
        5.973154362416107: 1.0644124555058704e-07,
        6.0: 9.090758895169395e-08,
    }
    pdf_values_alpha_2_5 = {
        2.5: 0.0,
        2.523489932885906: 0.018172316692105332,
        2.546979865771812: 0.024344806327421423,
        2.5704697986577183: 0.02822733279175803,
        2.5939597315436242: 0.030838591789410754,
        2.61744966442953: 0.03260187832401,
        2.640939597315436: 0.033749285568759856,
        2.664429530201342: 0.03442769417002647,
        2.6879194630872485: 0.03473864919041198,
        2.7114093959731544: 0.034756624165238906,
        2.7348993288590604: 0.03453859075233386,
        2.7583892617449663: 0.03412945629141297,
        2.7818791946308723: 0.033565464320667704,
        2.8053691275167787: 0.03287635048094294,
        2.8288590604026846: 0.03208684817495405,
        2.8523489932885906: 0.031217734112797327,
        2.8758389261744965: 0.030286587428751188,
        2.899328859060403: 0.029308366879479863,
        2.922818791946309: 0.028295861361416333,
        2.946308724832215: 0.02725997480639796,
        2.969798657718121: 0.026210115276070128,
        2.9932885906040267: 0.025154301567609803,
        3.0167785234899327: 0.02409940456234883,
        3.040268456375839: 0.023051290215295596,
        3.063758389261745: 0.02201493891351715,
        3.087248322147651: 0.020994566540854038,
        3.110738255033557: 0.019993709223468478,
        3.1342281879194633: 0.019015307819800292,
        3.1577181208053693: 0.018061777779884006,
        3.1812080536912752: 0.017135073557106414,
        3.204697986577181: 0.01623673609209546,
        3.228187919463087: 0.015367951377843117,
        3.251677852348993: 0.014529591911558636,
        3.2751677852348995: 0.013722238744251563,
        3.2986577181208054: 0.012946237175350213,
        3.3221476510067114: 0.012201721303550489,
        3.3456375838926173: 0.011488624973413943,
        3.3691275167785237: 0.010806745577063941,
        3.3926174496644297: 0.01015571012562268,
        3.4161073825503356: 0.009535048414080049,
        3.4395973154362416: 0.00894417373409975,
        3.4630872483221475: 0.008382429206607166,
        3.4865771812080535: 0.007849072266907545,
        3.5100671140939594: 0.0073433119585612884,
        3.533557046979866: 0.0068691996657928925,
        3.557046979865772: 0.006362328146204488,
        3.580536912751678: 0.005889350688741936,
        3.604026845637584: 0.005448292819643237,
        3.62751677852349: 0.005037271774197377,
        3.651006711409396: 0.004654494055904622,
        3.674496644295302: 0.004298252910499436,
        3.697986577181208: 0.003966925731100434,
        3.721476510067114: 0.0036589714097604847,
        3.7449664429530203: 0.0033729276496245113,
        3.7684563758389262: 0.003107408250884071,
        3.791946308724832: 0.0028611003827614077,
        3.8154362416107386: 0.0026327618527857252,
        3.8389261744966445: 0.002421218383655953,
        3.8624161073825505: 0.002225360907115717,
        3.8859060402684564: 0.0020441428833855354,
        3.9093959731543624: 0.0018765776538429556,
        3.9328859060402683: 0.0017217358338449344,
        3.9563758389261743: 0.0015787427518280672,
        3.9798657718120807: 0.0014467759400790241,
        4.003355704697986: 0.00132506268188169,
        4.026845637583893: 0.0012128776191095477,
        4.050335570469799: 0.0011095404236738872,
        4.073825503355705: 0.0010144135357313165,
        4.097315436241611: 0.000926899970942195,
        4.120805369127517: 0.0008464411986265204,
        4.144295302013423: 0.0007725150921705459,
        4.167785234899329: 0.000704633952615261,
        4.191275167785235: 0.0006423426059865695,
        4.214765100671141: 0.0005852165745140418,
        4.2382550335570475: 0.0005328603216184848,
        4.2617449664429525: 0.00048490557022114937,
        4.285234899328859: 0.00044100969365071073,
        4.308724832214765: 0.00040085417821897394,
        4.332214765100671: 0.0003641431562868159,
        4.355704697986577: 0.00033060200849982984,
        4.379194630872483: 0.00029997603366425116,
        4.402684563758389: 0.0002720291846315582,
        4.426174496644295: 0.0002465428684296424,
        4.449664429530202: 0.0002233148087734081,
        4.473154362416107: 0.00020215796902004252,
        4.496644295302014: 0.00018289953356271095,
        4.520134228187919: 0.00016537994561520675,
        4.543624161073826: 0.00014945199930298052,
        4.567114093959732: 0.00013497998396000204,
        4.590604026845638: 0.00012183887851724034,
        4.614093959731544: 0.00010991359388040933,
        4.6375838926174495: 9.909826119799511e-05,
        4.661073825503356: 8.929556394777813e-05,
        4.684563758389261: 8.041611179503288e-05,
        4.708053691275168: 7.237785421487164e-05,
        4.731543624161073: 6.510553190841245e-05,
        4.75503355704698: 5.8530164090258386e-05,
        4.778523489932886: 5.2588569776821534e-05,
        4.802013422818792: 4.722292125586823e-05,
        4.825503355704698: 4.23803279773518e-05,
        4.848993288590604: 3.801244916206948e-05,
        4.872483221476511: 3.407513348806758e-05,
        4.895973154362416: 3.052808427545478e-05,
        4.919463087248323: 2.733454865242303e-05,
        4.942953020134228: 2.4461029250266575e-05,
        4.966442953020135: 2.1877017037258568e-05,
        4.989932885906041: 1.955474396380025e-05,
        5.0134228187919465: 1.746895415497078e-05,
        5.0369127516778525: 1.5596692445945304e-05,
        5.060402684563758: 1.3917109118250379e-05,
        5.083892617449664: 1.2411279751685159e-05,
        5.10738255033557: 1.1062039165818795e-05,
        5.130872483221477: 9.853828480023868e-06,
        5.154362416107382: 8.77255437559881e-06,
        5.177852348993289: 7.805459695740003e-06,
        5.201342281879194: 6.941004569799782e-06,
        5.224832214765101: 6.168757296801433e-06,
        5.248322147651007: 5.479294269878214e-06,
        5.271812080536913: 4.8641082680009416e-06,
        5.295302013422819: 4.315524484066256e-06,
        5.318791946308725: 3.826623699115383e-06,
        5.342281879194632: 3.3911720512544616e-06,
        5.365771812080537: 3.0035568847885278e-06,
        5.3892617449664435: 2.6587281997996368e-06,
        5.412751677852349: 2.352145255761797e-06,
        5.436241610738255: 2.079727913874228e-06,
        5.459731543624161: 1.8378123323513258e-06,
        5.483221476510067: 1.6231106568464179e-06,
        5.506711409395973: 1.4326743741556587e-06,
        5.530201342281879: 1.263861022132232e-06,
        5.553691275167785: 1.1143039716579828e-06,
        5.577181208053691: 9.818850182270285e-07,
        5.600671140939598: 8.647095408534574e-07,
        5.624161073825503: 7.610840049190576e-07,
        5.64765100671141: 6.694956032016434e-07,
        5.671140939597315: 5.885938457276148e-07,
        5.694630872483222: 5.171739243916784e-07,
        5.718120805369128: 4.5416169245976915e-07,
        5.741610738255034: 3.98600112296143e-07,
        5.76510067114094: 3.4963703683891593e-07,
        5.7885906040268456: 3.065142017035698e-07,
        5.812080536912752: 2.685573152475719e-07,
        5.8355704697986575: 2.3516714362564373e-07,
        5.859060402684564: 2.0581149677883895e-07,
        5.882550335570469: 1.7955282363464585e-07,
        5.906040268456376: 1.5696110703696575e-07,
        5.929530201342282: 1.3698689869448997e-07,
        5.953020134228188: 1.1961506879985926e-07,
        5.976510067114094: 1.0438698630366786e-07,
        6.0: 9.090758895169395e-08,
    }
    pdf_values_alpha_3_0 = {
        3.0: 0.0,
        3.0201342281879193: 0.004645171070452048,
        3.040268456375839: 0.006206175358972645,
        3.0604026845637584: 0.007173723983423465,
        3.0805369127516777: 0.007816685327119493,
        3.1006711409395975: 0.008243257716587883,
        3.120805369127517: 0.008513791424461853,
        3.140939597315436: 0.008666473856563396,
        3.1610738255033555: 0.008727645591668798,
        3.1812080536912752: 0.008716555318550001,
        3.2013422818791946: 0.008647844214954662,
        3.221476510067114: 0.008533000100999007,
        3.2416107382550337: 0.008381213047471931,
        3.261744966442953: 0.008199963143474638,
        3.2818791946308723: 0.00799543705624268,
        3.302013422818792: 0.007772752150134479,
        3.3221476510067114: 0.007536232149482261,
        3.3422818791946307: 0.007289499939731807,
        3.3624161073825505: 0.007035620763080417,
        3.38255033557047: 0.006777197599008319,
        3.402684563758389: 0.006516430789062372,
        3.422818791946309: 0.006255187723297686,
        3.442953020134228: 0.005995043955180313,
        3.4630872483221475: 0.00573733222936324,
        3.4832214765100673: 0.005481563713479747,
        3.5033557046979866: 0.005233474352253484,
        3.523489932885906: 0.0049890377500433885,
        3.5436241610738257: 0.004750467399401508,
        3.563758389261745: 0.004518285989972739,
        3.5838926174496644: 0.004292878687931262,
        3.604026845637584: 0.00407455989137526,
        3.6241610738255035: 0.0038635560224456584,
        3.6442953020134228: 0.0036600121805663625,
        3.664429530201342: 0.0034640325130939832,
        3.6845637583892614: 0.003275650837781352,
        3.704697986577181: 0.0030948593055226013,
        3.7248322147651005: 0.002921612570695695,
        3.74496644295302: 0.002755838335295026,
        3.7651006711409396: 0.0025974186859541617,
        3.785234899328859: 0.0024462224813569383,
        3.8053691275167782: 0.002302093125005708,
        3.825503355704698: 0.002164866562549065,
        3.8456375838926173: 0.0020343570931425007,
        3.8657718120805367: 0.0019103601606501692,
        3.8859060402684564: 0.0017926814901567563,
        3.9060402684563758: 0.0016811084599378258,
        3.926174496644295: 0.0015754237101405306,
        3.946308724832215: 0.001475439077432711,
        3.966442953020134: 0.0013808571809850964,
        3.9865771812080535: 0.001291536590130063,
        4.006711409395973: 0.0012072309206074855,
        4.026845637583893: 0.0011277292352036583,
        4.046979865771812: 0.0010528125996891854,
        4.067114093959732: 0.0009822902113097985,
        4.087248322147651: 0.0009159354859835958,
        4.10738255033557: 0.000853558927757987,
        4.12751677852349: 0.0007949627359080486,
        4.14765100671141: 0.0007399629452998086,
        4.167785234899329: 0.000688373405164115,
        4.1879194630872485: 0.0006400148082640508,
        4.208053691275168: 0.0005947602478113396,
        4.228187919463087: 0.0005523189356270556,
        4.248322147651007: 0.0005117898743013644,
        4.268456375838926: 0.0004719640885611253,
        4.2885906040268456: 0.0004350513290387064,
        4.308724832214765: 0.00040085417821897394,
        4.328859060402684: 0.00036918733066355566,
        4.348993288590604: 0.0003398769486142873,
        4.369127516778523: 0.00031276004442134343,
        4.389261744966443: 0.0002876838892512443,
        4.409395973154362: 0.0002645054474770188,
        4.429530201342281: 0.00024309083613171728,
        4.449664429530201: 0.00022331480877353635,
        4.469798657718121: 0.00020506026310091176,
        4.48993288590604: 0.00018821777162786248,
        4.510067114093959: 0.00017268513472208427,
        4.530201342281879: 0.00015836695529889986,
        4.550335570469798: 0.00014517423445862792,
        4.570469798657718: 0.00013302398734571866,
        4.590604026845638: 0.00012183887851724034,
        4.6107382550335565: 0.00011154687610182037,
        4.630872483221476: 0.0001020809240404546,
        4.651006711409396: 9.337863170099399e-05,
        4.671140939597315: 8.538198017535864e-05,
        4.691275167785235: 7.803704456822031e-05,
        4.7114093959731544: 7.129373160714272e-05,
        4.731543624161073: 6.510553190841245e-05,
        4.751677852348993: 5.942928625450047e-05,
        4.771812080536913: 5.422496524856203e-05,
        4.791946308724832: 4.945546172942466e-05,
        4.8120805369127515: 4.508639534799381e-05,
        4.832214765100671: 4.108592872098896e-05,
        4.85234899328859: 3.742459459707403e-05,
        4.87248322147651: 3.407513348806968e-05,
        4.89261744966443: 3.101234123576808e-05,
        4.912751677852349: 2.8212926003801955e-05,
        4.932885906040268: 2.5655374202126934e-05,
        4.953020134228188: 2.3319824869723675e-05,
        4.973154362416107: 2.118795206046448e-05,
        4.993288590604027: 1.9242854794417404e-05,
        5.0134228187919465: 1.746895415497078e-05,
        5.033557046979865: 1.5851897130605282e-05,
        5.053691275167785: 1.4378466816635523e-05,
        5.073825503355705: 1.303649861002414e-05,
        5.093959731543624: 1.181480204696572e-05,
        5.114093959731544: 1.070308794923924e-05,
        5.134228187919463: 9.691900561295735e-06,
        5.154362416107382: 8.77255437559881e-06,
        5.174496644295302: 7.937075358658487e-06,
        5.194630872483222: 7.1781463049196366e-06,
        5.214765100671141: 6.4890560597078775e-06,
        5.23489932885906: 5.86365236581295e-06,
        5.25503355704698: 5.296298101824402e-06,
        5.275167785234899: 4.781830692537985e-06,
        5.295302013422819: 4.315524484066256e-06,
        5.315436241610739: 3.893055887861904e-06,
        5.3355704697986575: 3.51047110905001e-06,
        5.355704697986577: 3.16415628501877e-06,
        5.375838926174497: 2.8508098704840246e-06,
        5.395973154362416: 2.5674171149207466e-06,
        5.416107382550336: 2.311226487556209e-06,
        5.436241610738255: 2.079727913874228e-06,
        5.456375838926174: 1.8706326960075942e-06,
        5.476510067114093: 1.681854997373345e-06,
        5.496644295302014: 1.5114947794260324e-06,
        5.516778523489933: 1.3578220855625928e-06,
        5.536912751677852: 1.2192625740613128e-06,
        5.557046979865772: 1.0943842082453178e-06,
        5.577181208053691: 9.818850182270285e-07,
        5.59731543624161: 8.805818542247288e-07,
        5.617449664429531: 7.894000568818766e-07,
        5.6375838926174495: 7.07363975095216e-07,
        5.657718120805368: 6.335882666306968e-07,
        5.677852348993289: 5.672699212948765e-07,
        5.697986577181208: 5.076809506844251e-07,
        5.718120805369127: 4.5416169245977444e-07,
        5.738255033557047: 4.061146808487325e-07,
        5.758389261744966: 3.629990385338891e-07,
        5.778523489932885: 3.243253483618819e-07,
        5.798657718120805: 2.8965096635982914e-07,
        5.818791946308725: 2.585757403785578e-07,
        5.838926174496644: 2.3073810137173082e-07,
        5.859060402684563: 2.058114967788012e-07,
        5.879194630872483: 1.8302693077488562e-07,
        5.899328859060402: 1.6311840883241537e-07,
        5.919463087248322: 1.4531479700179725e-07,
        5.939597315436242: 1.292615297039356e-07,
        5.9597315436241605: 1.1505725923049881e-07,
        5.97986577181208: 1.023711881067374e-07,
        6.0: 9.090758895169395e-08,
    }
    pdf_values_alpha_3_5 = {
        3.5: 0.0,
        3.5167785234899327: 0.000902468703164434,
        3.533557046979866: 0.0012063126280990662,
        3.5503355704697985: 0.0013960361632073166,
        3.5671140939597317: 0.0015227391840888292,
        3.5838926174496644: 0.0016077338478381262,
        3.6006711409395975: 0.001662680756846087,
        3.61744966442953: 0.0016949590429054598,
        3.634228187919463: 0.0017096283743761789,
        3.651006711409396: 0.0017103936999603388,
        3.6677852348993287: 0.0017000734964759553,
        3.684563758389262: 0.0016808453521605046,
        3.7013422818791946: 0.0016544680380606294,
        3.7181208053691277: 0.001622354185974268,
        3.7348993288590604: 0.0015856915363862327,
        3.751677852348993: 0.001545437607081538,
        3.7684563758389262: 0.0015024195711069005,
        3.785234899328859: 0.001457312097976992,
        3.802013422818792: 0.0014100167926449608,
        3.8187919463087248: 0.0013630576569551808,
        3.835570469798658: 0.0013148216515011504,
        3.8523489932885906: 0.0012663333362582805,
        3.8691275167785237: 0.0012178917392399852,
        3.8859060402684564: 0.0011697485853499215,
        3.902684563758389: 0.0011221159472067747,
        3.9194630872483223: 0.001075175541211396,
        3.936241610738255: 0.00102907537192188,
        3.953020134228188: 0.0009839273338789845,
        3.969798657718121: 0.0009398433844411999,
        3.9865771812080535: 0.0008968995991988211,
        4.003355704697986: 0.0008551586513439545,
        4.02013422818792: 0.0008146674905124865,
        4.0369127516778525: 0.0007754639160859023,
        4.053691275167785: 0.0007375755080914108,
        4.070469798657718: 0.0007010011628587395,
        4.087248322147651: 0.0006657626919535824,
        4.104026845637584: 0.0006318538747006737,
        4.120805369127517: 0.000599264244702808,
        4.1375838926174495: 0.0005679820509955138,
        4.154362416107382: 0.0005379780354192329,
        4.171140939597316: 0.0005092582357001032,
        4.1879194630872485: 0.0004817852454635435,
        4.204697986577181: 0.0004555189724242017,
        4.221476510067114: 0.0004304333090816665,
        4.2382550335570475: 0.0004065031764776806,
        4.25503355704698: 0.00038369227060755707,
        4.271812080536913: 0.00036196727632267046,
        4.2885906040268456: 0.0003412931563685374,
        4.305369127516778: 0.0003216300368063052,
        4.322147651006711: 0.0003029708397964653,
        4.3389261744966445: 0.00028520800732879573,
        4.355704697986577: 0.0002683767796434645,
        4.37248322147651: 0.0002524144651275265,
        4.389261744966443: 0.00023729054451885798,
        4.406040268456376: 0.00022296806149577352,
        4.422818791946309: 0.00020941217475654522,
        4.439597315436242: 0.00019659195246659767,
        4.456375838926174: 0.00018447073096731803,
        4.473154362416107: 0.00017302474353867326,
        4.489932885906041: 0.00016221652014472863,
        4.506711409395973: 0.00015201338767855207,
        4.523489932885906: 0.0001423957886196974,
        4.540268456375839: 0.00013332828029626634,
        4.557046979865772: 0.00012477685334164696,
        4.573825503355705: 0.00011674070381253782,
        4.590604026845638: 0.00010917127783709911,
        4.60738255033557: 0.00010205057298254237,
        4.624161073825503: 9.535345199002349e-05,
        4.640939597315436: 8.906420555490516e-05,
        4.657718120805369: 8.31542920035364e-05,
        4.674496644295302: 7.760577302229842e-05,
        4.691275167785235: 7.240019133359976e-05,
        4.708053691275168: 6.751597049430289e-05,
        4.724832214765101: 6.293902706550903e-05,
        4.741610738255034: 5.864890885217576e-05,
        4.758389261744966: 5.4630447663172737e-05,
        4.775167785234899: 5.086815994933735e-05,
        4.791946308724832: 4.7346008096201766e-05,
        4.808724832214765: 4.403250254310375e-05,
        4.825503355704698: 4.097259777675468e-05,
        4.842281879194631: 3.8095935112210816e-05,
        4.859060402684564: 3.54020111405769e-05,
        4.875838926174497: 3.289201230210717e-05,
        4.89261744966443: 3.052348432049467e-05,
        4.909395973154362: 2.8414771956345333e-05,
        4.926174496644295: 2.6323914411555103e-05,
        4.942953020134228: 2.4418987229536685e-05,
        4.959731543624161: 2.2587432793987415e-05,
        4.976510067114094: 2.085123521775052e-05,
        4.993288590604027: 1.9242854794417404e-05,
        5.010067114093959: 1.77533392525265e-05,
        5.026845637583893: 1.6374327360940513e-05,
        5.043624161073826: 1.5098012643144473e-05,
        5.060402684563758: 1.3917109118250379e-05,
        5.077181208053691: 1.2824818969709065e-05,
        5.093959731543624: 1.181480204696572e-05,
        5.1107382550335565: 1.088114710828464e-05,
        5.12751677852349: 1.0018344717546288e-05,
        5.144295302013423: 9.221261710545998e-06,
        5.1610738255033555: 8.485117150530007e-06,
        5.177852348993289: 7.805459695740003e-06,
        5.194630872483222: 7.1781463049196366e-06,
        5.2114093959731544: 6.59932221052194e-06,
        5.228187919463087: 6.065402091766982e-06,
        5.24496644295302: 5.57305238330309e-06,
        5.2617449664429525: 5.1191746578566585e-06,
        5.278523489932886: 4.7008900241368115e-06,
        5.295302013422819: 4.315524484066256e-06,
        5.3120805369127515: 3.960595196075438e-06,
        5.328859060402685: 3.6337975935393545e-06,
        5.345637583892618: 3.332993310257518e-06,
        5.3624161073825505: 3.0561988668617874e-06,
        5.379194630872483: 2.801575074583862e-06,
        5.395973154362416: 2.5674171149207466e-06,
        5.412751677852349: 2.352145255761797e-06,
        5.429530201342282: 2.154296166697593e-06,
        5.446308724832215: 1.972514798024172e-06,
        5.4630872483221475: 1.8055467899416558e-06,
        5.47986577181208: 1.652231380103024e-06,
        5.496644295302014: 1.5114947794260324e-06,
        5.5134228187919465: 1.3823439877178186e-06,
        5.530201342281879: 1.263861022132232e-06,
        5.546979865771812: 1.1551975330486265e-06,
        5.563758389261745: 1.055569783314375e-06,
        5.580536912751677: 9.642539681368417e-07,
        5.597315436241611: 8.805818542251972e-07,
        5.614093959731544: 8.039367179596867e-07,
        5.630872483221477: 7.337495635438607e-07,
        5.64765100671141: 6.694956032016434e-07,
        5.6644295302013425: 6.106909825036127e-07,
        5.681208053691275: 5.568897349292049e-07,
        5.697986577181208: 5.076809506844251e-07,
        5.714765100671141: 4.626861457023226e-07,
        5.731543624161073: 4.2155681760826957e-07,
        5.748322147651007: 3.8397217620882774e-07,
        5.76510067114094: 3.4963703683891593e-07,
        5.781879194630872: 3.1827986562274365e-07,
        5.798657718120806: 2.8965096635982713e-07,
        5.815436241610739: 2.6352079941597895e-07,
        5.832214765100671: 2.3967842358264594e-07,
        5.848993288590604: 2.179300524468565e-07,
        5.865771812080537: 1.9809771735592863e-07,
        5.882550335570469: 1.7955282363464585e-07,
        5.899328859060402: 1.6311840883241537e-07,
        5.916107382550336: 1.4814532068309854e-07,
        5.932885906040268: 1.3436334757963178e-07,
        5.949664429530202: 1.2195912130931452e-07,
        5.966442953020135: 1.1066799503841598e-07,
        5.983221476510067: 1.0039315449987685e-07,
        6.0: 9.090758895169395e-08,
    }
    alpha_to_pdf = {
        0.: pdf_values_alpha_0_0,
        0.5: pdf_values_alpha_0_5,
        1.: pdf_values_alpha_1_0,
        1.5: pdf_values_alpha_1_5,
        2.: pdf_values_alpha_2_0,
        2.5: pdf_values_alpha_2_5,
        3.: pdf_values_alpha_3_0,
        3.5: pdf_values_alpha_3_5,
    }
    return alpha_to_pdf[alpha.item()]

#########################
##### Error Measures ####
#########################
class ErrorMeasure:
    def __init__(self):
        self.hist_approx_dir = f'{HydraConfig.get().run.dir}/histogram_approximations'
        os.makedirs(self.hist_approx_dir, exist_ok=True)
    def __call__(
        self,
        analytical_props,
        empirical_props,
        bins,
        alpha
    ):
        return self.error(analytical_props, empirical_props, bins, alpha)
    def error(
        self,
        analytical_props,
        empirical_props,
        bins,
        alpha
    ):
        raise NotImplementedError
    def plot(
        self,
        x_grid: np.ndarray,
        pdf_values: np.ndarray,
        empirical_props: np.ndarray,
        num_bins: int
    ):
        """
        x_grid has shape d x b
        pdf_values has shape d x b
        empirical_props has shape b
        """
        x_flattened = einops.rearrange(x_grid, 'b w -> (w b)')
        x_unique, idx = np.unique(x_flattened, return_index=True)
        props = einops.repeat(empirical_props, 'b -> (b w)', w=x_grid.shape[0])
        values = einops.rearrange(pdf_values, 'd b -> (b d)')
        plt.clf()
        plt.plot(x_flattened, props, c='orange')
        plt.scatter(x_flattened, props, c='orange')
        plt.plot(x_unique, values[idx], c='b')
        plt.scatter(x_unique, values[idx], c='b')
        plt.savefig(f'{self.hist_approx_dir}/histogram_approximation_{num_bins}.jpg')
        plt.clf()
    def clean_up(self):
        try:
            _create_gif(self.hist_approx_dir)
        except:
            pass

# class MaxError(ErrorMeasure):
#     def error(self, analytical_props, empirical_props):
#         return np.max(np.abs(
#             (analytical_props - empirical_props) / analytical_props
#         ))
#     def label(self):
#         return 'Maximum Error Across All Bins'

# class SumError(ErrorMeasure):
#     def error(self, analytical_props: np.ndarray, empirical_props: np.ndarray):
#         return np.sum(np.abs(
#             (analytical_props - empirical_props) / analytical_props
#         ))
#     def label(self):
#         return 'Sum of Errors Across All Bins'

# class ForwardKLError(ErrorMeasure):
#     def error(self, analytical_props: np.ndarray, empirical_props: np.ndarray):
#         if not np.all(empirical_props):
#             return np.array(100)
#         return np.sum(analytical_props * (np.log(analytical_props) - np.log(empirical_props)))
#     def label(self):
#         return 'Forward KL Divergence'

# class ReverseKLError(ErrorMeasure):
#     def error(self, analytical_props: np.ndarray, empirical_props: np.ndarray):
#         if not np.all(empirical_props):
#             return np.array(100)
#         return np.sum(empirical_props * (np.log(empirical_props) - np.log(analytical_props)))
#     def label(self):
#         return 'Reverse KL Divergence'

class SimpsonsMISE(ErrorMeasure):
    def error(
        self,
        analytical_calculator: AnalyticalCalculator,
        empirical_props: np.ndarray,
        bins: np.ndarray,
        alpha: np.ndarray
    ):
        pdf_values, x_grid = analytical_calculator(bins, alpha)
        # \int_a^b f^2(x)dx \approx (b-a)/6 * (f^2(a) + 4*f^2((b+a)/2) + f^2(b))
        mse_vec = (pdf_values[:-2:2] - empirical_props) ** 2 + \
                4 * (pdf_values[1:-1:2] - empirical_props) ** 2 + \
                (pdf_values[2::2] - empirical_props) ** 2
        mse = mse_vec.sum()
        self.plot(x_grid, pdf_values, empirical_props, len(bins))
        return mse
    def label(self):
        return 'Simpson\'s MISE'

class MISE(ErrorMeasure):
    def error(
        self,
        analytical_calculator: AnalyticalCalculator,
        empirical_props: np.ndarray,
        bins: np.ndarray,
        alpha: np.ndarray
    ):
        def compute_imse(dist, hist, bins, alpha):
            imse = 0
            for i in range(len(bins)-1):
                def integrand(x):
                    # mse = (dist.pdf(x) / (1 - dist.cdf(alpha)) - hist[i]) ** 2
                    mse = (dist(x) - hist[i]) ** 2
                    return mse
                result, _ = integrate.quad(integrand, bins[i], bins[i+1])
                imse += result
            # imse += (1 - dist.cdf(bins[-1])) / (1 - dist.cdf(alpha))
            return imse

        # mse = compute_imse(analytical_calculator.dist, empirical_props, bins, alpha)
        # mse += (1 - analytical_calculator.dist.cdf(bins[-1])) / (1 - analytical_calculator.dist.cdf(alpha))
        mse = compute_imse(lambda x: analytical_calculator.quadrature_fn(x, alpha), empirical_props, bins, alpha)

        # pdf_values, x_grid = analytical_calculator(bins, alpha)
        # mse = ((pdf_values - empirical_props) ** 2).sum()
        # self.plot(x_grid, pdf_values, empirical_props, len(bins))
        return mse
    def label(self):
        return 'Integrated MSE'

#########################
#### /Error Measures ####
#########################
